{extend name="./template/qq/m/pub/base.html" /}
{block name="seo"}
<title>漫画分类-{$site_name}</title>
{/block}
{block name="css"}
<link rel="stylesheet" href="/template/qq/css/category-list.css"/>
{/block}
{block name="main"}
<header class="top-bar #bar_style#">
    <a class="btn-top back" href="/">[返回]</a>
    <h1 class="top-title">分类</h1>
    <div class="top-logo">[腾讯动漫LOGO]</div>
    <div class="padding"></div>
    <a class="btn-top search" href="/{$search_ctrl}">[搜索]</a>
    <a class="btn-top menu">[菜单]</a>
</header>
<section class="categoryList-content content-update" id="app">
    <div id="end" class="manga-list-bar">
        <a class="manga-list-bar-item" @click="setEnd(-1)" :class="{'active': end==-1}">全部</a>
        <a class="manga-list-bar-item" @click="setEnd(2)" :class="{'active': end==2}">连载中</a>
        <a class="manga-list-bar-item" @click="setEnd(1)" :class="{'active': end==1}">已完结</a>
        <a id="manga-list-bar-right" class="manga-list-bar-right " @click="showList=!showList">分类</a>
        <div id="manga-list-bar-right-down" class="manga-list-bar-right-down" v-show="showList">
            <a class="manga-list-bar-right-down-item active">全部</a>
            <div v-for="(item, index) in tags" :key="index">
                <a class="manga-list-bar-right-down-item" @click="setTag(item.tag_name)" :class="{'active':tag==item.tag_name}">{{item.tag_name}}</a>
            </div>
        </div>
    </div>
    <div id="list_update_box" class="comic-list update active">
        <ul id="list_update">
            <li class="comic-item" v-for="(item, index) in books" :key="index">
                <a class="comic-link" :href="'/{$book_ctrl}/'+ item.param" :title="item.book_name">
                    <div class="comic-cover">
                        <img class="cover-image" :src="item.cover_url">
                    </div>
                    <div class="comic-info">
                        <strong class="comic-title">
                            {{item.book_name}}
                        </strong>
                        <small class="comic-update"> {{item.author_name}}</small>
                        <small class="comic-tag">{{item.tags}}</small>
                        <small class="comic-desc">{{item.summary}}</small>
                    </div>
                </a>
            </li>
        </ul>
    </div>
    <span style="margin-left: 40%; color: grey" @click="getMore()">
        {{isMore == 1 ? '点击加载更多' : '没有更多了'}}
    </span>
</section>
<a class="back-to-top show">[返回顶部]</a>
<div style="height: 0.5rem"></div>
{/block}
{block name="js"}
<script src="https://lib.baomitu.com/vue/2.6.10/vue.min.js"></script>
<script src="https://lib.baomitu.com/axios/0.19.2/axios.min.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            books: [],
            tags: [],
            tag: '全部',
            end: -1,
            page: 0,
            isMore: 1,
            showList: false
        },
        methods: {
            getBooks(isRefresh) {
                axios.get("/getBooks", {
                    params: {
                        tag: this.tag,
                        end: this.end,
                        page: this.page
                    }
                }).then(response => {
                    if (isRefresh == 1) { //为1是重新渲染
                        this.books = response.data.books
                    } else {
                        if (response.data.err == 1) {
                            this.isMore = 0 //设置好之后，上拉加载就不再请求接口了
                            ShowDialog('没有更多了')
                        } else {
                            this.books = this.books.concat(response.data.books)
                        }
                    }
                })
            },
            setTag(tag) {
                this.tag = tag
                this.page = 0
                this.isMore = 1
                this.getBooks(1)
            },
            setEnd(end) {
                this.end = end
                this.page = 0
                this.isMore = 1
                this.getBooks(1)
            },
            getMore() {
                if (this.isMore == 1) { //如果还有更多数据，再请求接口，否则不再请求，节省服务器资源
                                this.page = this.page + 15
                                this.getBooks(0)
                }
            }
            // onScroll() {                    //可滚动容器的高度
            //     var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            //     //变量windowHeight是可视区的高度
            //     var windowHeight = document.documentElement.clientHeight || document.body.clientHeight;
            //     //变量scrollHeight是滚动条的总高度
            //     var scrollHeight = document.documentElement.scrollHeight || document.body.scrollHeight;
            //     //滚动条到底部的条件
            //     if (scrollTop + windowHeight == scrollHeight) {
            //         if (this.isMore == 1) { //如果还有更多数据，再请求接口，否则不再请求，节省服务器资源
            //             this.page = this.page + 15
            //             this.getBooks(0)
            //         }
            //     }
            // }
        },
        mounted() {
            axios.get("/getOptions").then(response => {
                this.tags = response.data.tags
            })
            this.getBooks(1)
        },
        created() {
            window.addEventListener('scroll', this.onScroll);
        }
    })
</script>
<script src="https://lib.baomitu.com/jquery/3.5.0/jquery.min.js"></script>
<script>
    $(function () {
        // 获取要大于的高度
        var headheight = $('.title-content').height();
        window.addEventListener('scroll', function () {
            //获取浏览器滚轴滚动的距离
            var scrollTop = $(window).scrollTop();
            //当浏览器滚轴滚动的距离 大于 设定的高度时 显示“点击返回顶部”按钮，否则隐藏
            if (scrollTop > headheight) {
                $('.back-to-top').show()
            } else {
                $('.back-to-top').hide()
            }
        })

        //点击返回顶部500ms的滑动效果
        $('.back-to-top').on('click', function () {
            $('html,body').animate({scrollTop: 0}, 500);
        })
    })
</script>

{/block}